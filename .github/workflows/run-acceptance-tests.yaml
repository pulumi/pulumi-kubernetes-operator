---
name: Pulumi Kubernetes Operator PR Builds
on:
  pull_request:
    branches:
      - master
  repository_dispatch:
    types: [run-acceptance-tests-command]
env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PULUMI_BOT_TOKEN: ${{ secrets.PULUMI_BOT_TOKEN }}
  VERSION: v0.0-${{ github.sha }}
jobs:
  comment-notification:
    runs-on: ubuntu-latest
    name: comment-notification
    if: github.event_name == 'repository_dispatch'
    steps:
    - name: Create URL to the run output
      id: vars
      run: echo
        run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
        >> "$GITHUB_OUTPUT"
    - name: Update with Result
      uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
      with:
        token: ${{ secrets.PULUMI_BOT_TOKEN }}
        repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
        issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
        body: "Please view the PR build: ${{ steps.vars.outputs.run-url }}"

  build:
    uses: ./.github/workflows/build.yaml
    secrets: inherit
    if: github.event_name == 'repository_dispatch' ||
      github.event.pull_request.head.repo.full_name == github.repository
    with:
      repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
      ref: ${{ github.event.client_payload.pull_request.head.ref }}
      version: v0.0-${{ github.sha }}

  lint:
    uses: ./.github/workflows/lint.yaml
    secrets: inherit
    with:
      repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
      ref: ${{ github.event.client_payload.pull_request.head.ref }}

  unit-tests:
    uses: ./.github/workflows/unit-tests.yaml
    secrets: inherit
    if: github.event_name == 'repository_dispatch' ||
      github.event.pull_request.head.repo.full_name == github.repository
    with:
      repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
      ref: ${{ github.event.client_payload.pull_request.head.ref }}

  e2e-tests:
    uses: ./.github/workflows/e2e-tests.yaml
    secrets: inherit
    if: github.event_name == 'repository_dispatch' ||
      github.event.pull_request.head.repo.full_name == github.repository
    with:
      repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
      ref: ${{ github.event.client_payload.pull_request.head.ref }}