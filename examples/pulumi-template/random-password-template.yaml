# This example demonstrates how to use Template to create a dynamic CRD
# that provisions random passwords using the Pulumi random provider.
#
# When this Template is applied:
# 1. The operator generates a new CRD: randompasswords.secrets.example.com
# 2. Users can then create RandomPassword instances
# 3. Each instance triggers creation of a Pulumi Stack that generates a random password
# 4. The password is stored in a Kubernetes Secret and status is updated

apiVersion: pulumi.com/v1alpha1
kind: Template
metadata:
  name: random-password
  namespace: default
spec:
  # Schema defines the API schema for instances of the generated CRD,
  # including the CRD identity (apiVersion, kind) and field definitions.
  schema:
    # CRD identity - only apiVersion and kind are required
    apiVersion: secrets.example.com/v1
    kind: RandomPassword
    # plural: randompasswords  # Optional - auto-generated as lowercase(kind)+"s"
    scope: Namespaced
    categories:
      - secrets
    shortNames:
      - rp
      - randpwd
    printerColumns:
      - name: Length
        type: integer
        jsonPath: .spec.length
      - name: Special
        type: boolean
        jsonPath: .spec.special
      - name: SecretName
        type: string
        jsonPath: .status.secretName

    # Field definitions for the generated CRD
    spec:
      length:
        type: integer
        description: "Length of the generated password"
        default: 16
        minimum: 8
        maximum: 128
      special:
        type: boolean
        description: "Include special characters in the password"
        default: true
      minSpecial:
        type: integer
        description: "Minimum number of special characters"
        default: 2
        minimum: 0
        maximum: 10
      minNumeric:
        type: integer
        description: "Minimum number of numeric characters"
        default: 2
        minimum: 0
        maximum: 10
      minUpper:
        type: integer
        description: "Minimum number of uppercase characters"
        default: 2
        minimum: 0
        maximum: 10
      minLower:
        type: integer
        description: "Minimum number of lowercase characters"
        default: 2
        minimum: 0
        maximum: 10
      secretName:
        type: string
        description: "Name of the Kubernetes secret to store the password (defaults to instance name)"
        required: false
      secretKey:
        type: string
        description: "Key in the secret to store the password"
        default: "password"

    status:
      secretName:
        type: string
        description: "Name of the created Kubernetes secret"
      secretKey:
        type: string
        description: "Key in the secret containing the password"
      passwordLength:
        type: integer
        description: "Actual length of the generated password"

  # Define the Pulumi resources that will be created for each instance
  resources:
    password:
      type: random:RandomPassword
      properties:
        length: ${schema.spec.length}
        special: ${schema.spec.special}
        minSpecial: ${schema.spec.minSpecial}
        minNumeric: ${schema.spec.minNumeric}
        minUpper: ${schema.spec.minUpper}
        minLower: ${schema.spec.minLower}

    secret:
      type: kubernetes:core/v1:Secret
      properties:
        metadata:
          name: ${schema.spec.secretName || schema.metadata.name}
          namespace: ${schema.metadata.namespace}
          labels:
            app.kubernetes.io/managed-by: pulumi-operator
            pulumi.com/template: random-password
        stringData:
          ${schema.spec.secretKey}: ${password.result}

  # Map outputs to instance status
  outputs:
    secretName: ${secret.metadata.name}
    secretKey: ${schema.spec.secretKey}
    passwordLength: ${password.length}
    password: ${password.result}

  # Stack configuration
  stackConfig:
    serviceAccountName: pulumi-stack-sa
    envRefs:
      PULUMI_ACCESS_TOKEN:
        type: Secret
        secret:
          name: pulumi-api-secret
          key: accessToken

  lifecycle:
    destroyOnDelete: true
    refreshBeforeUpdate: false

---
# Example: Create a RandomPassword instance
# After the Template above is applied and the CRD is registered,
# you can create instances like this:

apiVersion: secrets.example.com/v1
kind: RandomPassword
metadata:
  name: my-app-password
  namespace: default
spec:
  length: 24
  special: true
  minSpecial: 4
  minNumeric: 4
  secretKey: db-password
